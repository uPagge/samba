---
kind: pipeline
type: docker
name: docker-graalvm-native

steps:

  - name: docker build an publish
    image: upagge/docker-buildx:latest
    environment:
      DOCKER_REGISTRY_TOKEN:
        from_secret: DOCKER_REGISTRY_TOKEN
      DOCKER_IMAGE_NAME:
        from_secret: DOCKER_IMAGE_NAME
      DOCKER_REGISTRY_USER:
        from_secret: DOCKER_REGISTRY_USER
    volumes:
      - name: dockersock
        path: /var/run
    commands:
      - sleep 15
      - echo "$DOCKER_REGISTRY_TOKEN" | docker login docker.io --username $DOCKER_REGISTRY_USER --password-stdin
      - docker buildx create --use
      - docker buildx build --push --platform linux/arm/v7,linux/arm64/v8,linux/amd64 -t "$DOCKER_IMAGE_NAME:new" .
#      - docker build -t "$DOCKER_IMAGE_NAME:latest" .
#      - docker push "$DOCKER_IMAGE_NAME:latest"

trigger:
  branch:
    - master

services:
  - name: docker
    image: docker:20.10.22-dind-alpine3.17
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run

volumes:
  - name: dockersock
    temp: {}
---
kind: signature
hmac: d5f23073e7a3295f7e4a8a52be94ef977bca9ddfa4e6505a58094dcb0fed9f3c

...
